package org.aotu.lswx.module;

import java.io.UnsupportedEncodingException;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.LinkedList;
import java.util.List;

import org.aotu.Jsons;
import org.aotu.lswx.entity.Work_ll_sjEntity;
import org.aotu.lswx.entity.Work_mx_sjEntity;
import org.aotu.lswx.entity.Work_pz_sjEntity;
import org.aotu.order.entity.Work_ll_gzEntity;
import org.aotu.publics.eneity.KehuEntity;
import org.aotu.publics.eneity.Work_cheliang_smEntity;
import org.nutz.dao.Cnd;
import org.nutz.dao.Dao;
import org.nutz.dao.Sqls;
import org.nutz.dao.entity.Record;
import org.nutz.dao.pager.Pager;
import org.nutz.dao.sql.Sql;
import org.nutz.dao.sql.SqlCallback;
import org.nutz.ioc.loader.annotation.Inject;
import org.nutz.ioc.loader.annotation.IocBean;
import org.nutz.json.Json;
import org.nutz.json.JsonFormat;
import org.nutz.mvc.annotation.At;
import org.nutz.mvc.annotation.Ok;


@IocBean
@At("/lswx")
public class lswxModule {
	
	@Inject
	Dao dao;
	
	@Inject
	Jsons jsons;
	
	/**
	 * 历史报价 
	 * @param che_no
	 * @param pageNumber
	 * @param type   0所有，1，快修
	 * @return
	 */
	@At("/")
	@Ok("raw:json")
	public String lswx(String che_no,int pageNumber,int type){
		System.out.println(pageNumber);
		Pager pager = dao.createPager(pageNumber, 20);
		List<Work_pz_sjEntity> result;
		//字段过多注意店家字段的时候有重复字段
		String sql_ = "select pz.Xche_jsrq,pz.Card_no,pz.Zhifu_card_no,pz.Zhifu_card_je,pz.Zhifu_card_xj,pz.Flag_cardjs,kh.kehu_mc,kh.kehu_xm,kh.kehu_dh,pz.id,pz.work_no,kh.kehu_no,kh.kehulb_mc,cl.che_no,pz.xche_hjje,pz.xche_jdrq,pz.xche_jcr from work_pz_sj pz,kehu kh,work_cheliang_sm cl where pz.kehu_no = kh.kehu_no and pz.che_no = cl.che_no";
		
		if(che_no!=null){
			sql_ = "select pz.Xche_jsrq,pz.Card_no,pz.Zhifu_card_no,pz.Zhifu_card_je,pz.Zhifu_card_xj,pz.Flag_cardjs,kh.kehu_mc,kh.kehu_xm,kh.kehu_dh,pz.id,pz.work_no,kh.kehu_no,kh.kehulb_mc,cl.che_no,pz.xche_hjje,pz.xche_jdrq,pz.xche_jcr from work_pz_sj pz,kehu kh,work_cheliang_sm cl where  pz.che_no like '%"+che_no+"%' and pz.kehu_no = kh.kehu_no and pz.che_no = cl.che_no";
		}
		if(type==1)
			sql_+=" and pz.flag_fast=1";
		else
			sql_+=" and pz.flag_fast=0";
		sql_+="  order by pz.id desc";
		Sql sql = Sqls.queryEntity(sql_);
		sql.setPager(pager);
		sql.setCallback(new SqlCallback() {
			public Object invoke(Connection conn, java.sql.ResultSet rs, Sql sql)
			throws SQLException {
			List<Work_pz_sjEntity> list = new LinkedList<Work_pz_sjEntity>();
			while (rs.next()){
				Work_pz_sjEntity pz = new Work_pz_sjEntity();
				pz.setId(rs.getInt("id"));
				pz.setWork_no(rs.getString("work_no"));
				pz.setKehu_no(rs.getString("kehu_no"));
				//客户电话
				pz.setKehu_bxno(rs.getString("kehu_dh"));
				pz.setKemu_mc(rs.getString("kehulb_mc"));
				pz.setChe_no(rs.getString("che_no"));
				pz.setXche_hjje(rs.getDouble("xche_hjje"));
				pz.setXche_jdrq(rs.getDate("xche_jdrq"));
				pz.setXche_jcr(rs.getString("xche_jcr"));
				pz.setKehu_mc(rs.getString("kehu_mc"));
				pz.setKehu_xm(rs.getString("kehu_xm"));
				pz.setKehu_dh(rs.getString("kehu_dh"));
				pz.setXche_jsrq(rs.getDate("Xche_jsrq"));
				pz.setCard_no(rs.getString("Card_no"));
				pz.setZhifu_card_no(rs.getString("Zhifu_card_no"));
				pz.setZhifu_card_je(rs.getDouble("Zhifu_card_je"));
				pz.setZhifu_card_xj(rs.getDouble("Zhifu_card_xj"));
				pz.setFlag_cardjs(rs.getBoolean("Flag_cardjs"));
				list.add(pz);
			}
			return list;
			}
		});
		dao.execute(sql);
		result =  sql.getList(Work_pz_sjEntity.class);
		String json = Json.toJson(result, JsonFormat.full());
		if (result.size() != 0) {
			return jsons.json(1, result.size(), 1, json);
		}
		return jsons.json(1, result.size(), 0, json);
	}
	
	/**
	 * 维修项目明细
	 * @param work_no
	 * @param pageNumber
	 * @return
	 */
	@At
	@Ok("raw:json")
	public String wxxm(String work_no,int pageNumber){
		Pager pager = dao.createPager(pageNumber, 20);
		List<Work_mx_sjEntity> result;
		if(work_no==null){
			 result = dao.query(Work_mx_sjEntity.class, null,pager);
		}else{
			result = dao.query(Work_mx_sjEntity.class, Cnd.where("work_no","=",work_no),pager);
		}
		
		String json = Json.toJson(result, JsonFormat.full());
		if (result.size() != 0) {
			return jsons.json(1, result.size(), 1, json);
		}
		return jsons.json(1, result.size(), 0, json);
	}
	
	
	/**
	 * 材料明细
	 * @param work_no
	 * @param pageNumber
	 * @return
	 */

	@At
	@Ok("raw:json")
	public String cail(String work_no,int pageNumber){
		Sql sql;
		sql = Sqls.queryRecord("select b.reco_no,b.work_no,a.peij_pp,a.peij_mc,b.peij_no,b.peij_sl,b.peij_dj,b.peij_je,a.peij_th,a.peij_th " +
				"from work_ll_sj b left join kucshp_info a on a.peij_no=b.peij_no where b.work_no='"+work_no+"'");
		dao.execute(sql);
		List<Record> result = sql.getList(Record.class);
		
		String json = Json.toJson(result, JsonFormat.full());
		if (result.size() != 0) {
			return jsons.json(1, result.size(), 1, json);
		}
		return jsons.json(1, result.size(), 0, json);
	}
	/**
	 * 历史维修信息
	 * 历史维修主表信息
	 * @param che_no
	 * @return
	 * @throws UnsupportedEncodingException 
	 */
	@At
	@Ok("raw:json")
	public String lswxxx(String che_no){
		if (che_no == null || che_no.equals("")) {
			return jsons.json(1, 1, 0, "车牌号无效，请输入正确车牌号。");
		}
		StringBuffer sql_ = new StringBuffer();
		sql_.append("select pz.work_no,pz.Xche_jsrq,kh.kehu_mc,kh.kehu_sj,pz.Card_no,pz.Zhifu_card_no,pz.Zhifu_card_je,pz.Zhifu_card_xj,"
				+ "pz.Flag_cardjs,kh.kehu_xm,kh.kehu_dh,pz.id,kh.kehu_no,kh.kehulb_mc,"
				+ "pz.xche_hjje,pz.xche_jdrq,pz.xche_jcr,pz.xche_cclc,pz.xche_ysje  "
				+ "from work_pz_sj pz,kehu kh  where pz.kehu_no = kh.kehu_no and  pz.che_no = '"
				+ che_no + "'");

		sql_.append("  order by pz.Xche_jsrq desc");
		Sql sql = Sqls.queryRecord(sql_.toString());
		dao.execute(sql);
		List<Record> res = sql.getList(Record.class);
		String json = Json.toJson(res, JsonFormat.full());
		if (res.size() != 0) {
			return jsons.json(1, res.size(), 1, json);
		}
		return jsons.json(1, res.size(), 0, json);
	}

	/**
	 * 历史维修项目明细
	 * 
	 * @param work_no
	 * @param pageNumber
	 * @return
	 * @throws UnsupportedEncodingException 
	 */
	@At
	@Ok("raw:json")
	public String lswxxmxx(String work_no){
		if (work_no == null || work_no.equals("")) {
			return jsons.json(1, 1, 0, "历史维修单号不能为空，请检查数据。");
		}
		List<Work_mx_sjEntity> result = dao.query(Work_mx_sjEntity.class, Cnd
				.where("work_no", "=", work_no).asc("reco_no"));

		String json = Json.toJson(result, JsonFormat.full());
		if (result.size() != 0) {
			return jsons.json(1, result.size(), 1, json);
		}
		return jsons.json(1, result.size(), 0, json);
	}
	/**
	 * 历史维修用料信息
	 * 
	 * @param work_no
	 * @param pageNumber
	 * @return
	 */

	@At
	@Ok("raw:json")
	public String lswxylxx(String work_no) {
		if (work_no == null || work_no.equals("")) {
			return jsons.json(1, 1, 0, "维修单号无效，请选择正确的维修单号。");
		}
		Sql sql = Sqls
				.queryRecord("select b.peij_no,a.peij_mc,a.peij_th,b.peij_sl,b.peij_dj,b.peij_je,b.reco_no,b.work_no "
						+ "from work_ll_sj b left join kucshp_info a on a.peij_no=b.peij_no where b.work_no='"
						+ work_no + "' order by reco_no");
		dao.execute(sql);
		List<Record> result = sql.getList(Record.class);
		String json = Json.toJson(result, JsonFormat.full());
		if (result.size() != 0) {
			return jsons.json(1, result.size(), 1, json);
		}
		return jsons.json(1, result.size(), 0, json);
	}
	/**
	 * 历史维修建议主表信息
	 * 
	 * @param che_no
	 * @return
	 * @throws UnsupportedEncodingException 
	 */
	@At
	@Ok("raw:json")
	public String lswxjyzb(String che_no){
		if (che_no == null || che_no.equals("")) {
			return jsons.json(1, 1, 0, "车牌号无效，请输入正确车牌号。");
		}
		StringBuffer sql_ = new StringBuffer();
		sql_.append("select work_no,xche_jsrq as rq ,kehu_mc,card_no,p.kehu_sj,xche_cclc,xche_ysje"
				+ " from work_pz_sj p ,kehu  k where p.che_no = '"
				+ che_no
				+ "' and p.kehu_no=k.kehu_no and work_no "
				+ "in (select work_no from work_mx_jianyi where che_no = '"
				+ che_no
				+ "'  union "
				+ " select work_no from work_ll_jianyi where che_no = '"
				+ che_no + "') order by xche_jsrq desc");
		Sql sql = Sqls.queryRecord(sql_.toString());
		dao.execute(sql);
		List<Record> res = sql.getList(Record.class);
		String json = Json.toJson(res, JsonFormat.full());
		if (res.size() != 0) {
			return jsons.json(1, res.size(), 1, json);
		}

		return jsons.json(1, res.size(), 0, json);

	}

	/**
	 * 历史维修项目建议
	 * 
	 * @param work_no
	 * @param pageNumber
	 * @return
	 */
	@At
	@Ok("raw:json")
	public String lswxxmjy(String work_no) {
		if (work_no == null || work_no.equals("")) {
			return jsons.json(1, 1, 0, "维修单号无效，请选择正确的维修单号。");
		}
		StringBuffer sql_ = new StringBuffer();
		sql_.append("select work_no,jianyi_rq, wxxm_no,wxxm_mc,wxxm_gs,wxxm_je,wxxm_dj,jianyi_state "
				+ "from work_mx_jianyi where work_no = '"
				+ work_no
				+ "'  order by reco_no");
		Sql sql = Sqls.queryRecord(sql_.toString());
		dao.execute(sql);
		List<Record> res = sql.getList(Record.class);
		String json = Json.toJson(res, JsonFormat.full());
		if (res.size() != 0) {
			return jsons.json(1, res.size(), 1, json);
		}

		return jsons.json(1, res.size(), 0, json);

	}

	/**
	 * 历史维修配件建议
	 * 
	 * @param work_no
	 * @param pageNumber
	 * @return
	 */
	@At
	@Ok("raw:json")
	public String lswxpjjy(String work_no) {
		if (work_no == null || work_no.equals("")) {
			return jsons.json(1, 1, 0, "维修单号无效，请选择正确的维修单号。");
		}
		StringBuffer sql_ = new StringBuffer();
		sql_.append("select work_no,jianyi_rq,peij_no,peij_th,peij_mc,peij_dw,peij_sl,peij_dj,peij_je,jianyi_state "
				+ "from work_ll_jianyi where  work_no='"
				+ work_no
				+ "' order by reco_no ");
		Sql sql = Sqls.queryRecord(sql_.toString());
		dao.execute(sql);
		List<Record> res = sql.getList(Record.class);
		String json = Json.toJson(res, JsonFormat.full());
		
		if (res.size() != 0) {
			return jsons.json(1, res.size(), 1, json);
		}

		return jsons.json(1, res.size(), 0, json);
	}
}
